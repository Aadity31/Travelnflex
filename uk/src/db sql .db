//create user 
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    name TEXT,
    email TEXT NOT NULL UNIQUE,
    image TEXT,

    password_hash TEXT,  -- sirf manual users ke liye

    auth_provider TEXT NOT NULL 
      CHECK (auth_provider IN ('google', 'credentials')),

    google_id TEXT UNIQUE,  -- sirf Google users ke liye

    email_verified BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

//user profile 
-- Profile table - only additional info, NOT name/email
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    
    -- Basic Profile Info
    phone VARCHAR(50),
    location VARCHAR(255),
    bio TEXT CHECK (LENGTH(bio) <= 500),
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index
CREATE INDEX idx_profiles_user_id ON profiles(user_id);

-- Auto-update trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_profiles_updated_at 
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Auto-create profile when user is created
CREATE OR REPLACE FUNCTION create_profile_for_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO profiles (user_id) VALUES (NEW.id);
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER auto_create_profile
    AFTER INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION create_profile_for_user();


//otp var 
CREATE TABLE otp_verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    email TEXT NOT NULL UNIQUE,

    otp_hash TEXT NOT NULL,                 -- hashed OTP only

    expires_at TIMESTAMPTZ NOT NULL,         -- expiry time

    attempts INT DEFAULT 0 CHECK (attempts <= 5),

    verified BOOLEAN DEFAULT FALSE,

    user_data JSONB,                        -- temp data (password already hashed)

    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for cleanup & verification performance
CREATE INDEX idx_otp_expires_at ON otp_verifications(expires_at);


1Ô∏è‚É£ agencies TABLE
CREATE TABLE agencies (
    id SERIAL PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,            -- AG01, APS, RSHK
    name TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'active', -- active | blacklisted
    created_at TIMESTAMPTZ DEFAULT NOW()
);

2Ô∏è‚É£ activities TABLE (with engineered ID)
CREATE TABLE activities (
    id TEXT PRIMARY KEY,   -- <AGENCY_CODE>_<ACTIVITY_TYPE>_<SEQ>

    agency_code TEXT NOT NULL
        REFERENCES agencies(code) ON UPDATE CASCADE,

    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL,

    type TEXT NOT NULL CHECK (
        type IN ('adventure','spiritual','cultural','food','trekking')
    ),

    description TEXT NOT NULL,
    short_description TEXT NOT NULL,

    duration TEXT NOT NULL,
    location TEXT NOT NULL,

    difficulty TEXT NOT NULL CHECK (
        difficulty IN ('easy','moderate','difficult')
    ),

    rating NUMERIC(2,1) DEFAULT 0,
    review_count INT DEFAULT 0,

    max_group_size INT NOT NULL,

    cover_image TEXT NOT NULL,      -- Cloudinary URL
    gallery_images TEXT[] NOT NULL, -- Cloudinary URLs

    highlights TEXT[] NOT NULL,     -- English only

    is_popular BOOLEAN DEFAULT FALSE,
    is_trending BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- üîí SAFETY CHECK
    CHECK (id LIKE agency_code || '\_%')
);

3Ô∏è‚É£ PRICE TABLE
CREATE TABLE activity_prices (
    activity_id TEXT PRIMARY KEY
        REFERENCES activities(id) ON DELETE CASCADE,

    price_min INT NOT NULL CHECK (price_min >= 0),
    price_max INT NOT NULL CHECK (price_max >= price_min),
    currency TEXT DEFAULT 'INR'
);

4Ô∏è‚É£ DISCOUNT TABLE
CREATE TABLE activity_discounts (
    activity_id TEXT PRIMARY KEY
        REFERENCES activities(id) ON DELETE CASCADE,

    percentage INT CHECK (percentage BETWEEN 1 AND 90),
    valid_until DATE NOT NULL
);

ALTER TABLE activities
ADD COLUMN includes TEXT[] DEFAULT ARRAY[]::text[];


5Ô∏è‚É£ üî• AUTO SEQUENCE GENERATOR (IMPORTANT)
Function to generate <AGENCY_CODE>_<ACTIVITY_TYPE>_<SEQ>
CREATE OR REPLACE FUNCTION generate_activity_id(
    p_agency_code TEXT,
    p_activity_type TEXT
)
RETURNS TEXT AS $$
DECLARE
    seq INT;
BEGIN
    SELECT COUNT(*) + 1
    INTO seq
    FROM activities
    WHERE agency_code = p_agency_code
      AND type = p_activity_type;

    RETURN p_agency_code || '_' || UPPER(SUBSTRING(p_activity_type, 1, 4)) || '_' ||
           LPAD(seq::TEXT, 3, '0');
END;
$$ LANGUAGE plpgsql;

7Ô∏è‚É£ üî• BLACKLIST AGENCY (1 QUERY)
UPDATE agencies SET status = 'blacklisted'
WHERE code = 'APS';

UPDATE activities
SET is_active = false
WHERE agency_code = 'APS';

8Ô∏è‚É£ PROMOTE YOUR OWN AGENCY (QUERY LOGIC)
SELECT *
FROM activities
WHERE is_active = true
ORDER BY
    CASE WHEN agency_code = 'APS' THEN 0 ELSE 1 END,
    rating DESC;